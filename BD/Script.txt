create database BD;
use  BD;


create table rol (idrol INT
 primary key auto_increment not null,
 Nombre varchar(30)

);
select * from Usuario;
create table Usuarios (idusua INT
 primary key auto_increment not null,
 Nombre varchar(30),
 contrase침a varbinary(64) not null,
 correo varchar(50) not null,
 id_rol int not null,
FOREIGN KEY (id_rol) REFERENCES Rol(idrol)
);


insert into Rol(nombre) values 
("admin"),
("usuario");

insert into Usuarios(Nombre,contrase침a,correo,id_rol)
values("admin","1234","admin@admin",1);

ALTER TABLE usuarios 
MODIFY id_rol INT NOT NULL DEFAULT 2;

UPDATE Usuarios
SET `contrase침a` = UNHEX(SHA2('1234', 512))
WHERE Nombre = 'admin';



select * from Usuarios;
select * from rol;


----------------------------------------------------------------------------------------------------------------------------------------------------------




DELIMITER //
CREATE FUNCTION fn_porcentaje(parte DECIMAL(18,2), total DECIMAL(18,2))
RETURNS DECIMAL(5,2)
DETERMINISTIC
BEGIN
    DECLARE resultado DECIMAL(5,2);
    IF total = 0 THEN
        SET resultado = 0;
    ELSE
        SET resultado = (parte / total) * 100;
    END IF;
    RETURN resultado;
END //
DELIMITER ;

SELECT fn_porcentaje(50, 200) AS Porcentaje;  



 DELIMITER //
CREATE FUNCTION fn_total_anual(anio INT)
RETURNS DECIMAL(18,2)
DETERMINISTIC
BEGIN
    DECLARE total DECIMAL(18,2);

    SELECT SUM(dp.Cantidad * dp.PrecioUnidad * (1 - dp.Descuento))
    INTO total
    FROM detalles_de_pedido dp
    JOIN pedido p ON dp.IdPedido = p.IdPedido
    WHERE YEAR(p.FechaPedido) = anio;

    RETURN IFNULL(total, 0);
END //
DELIMITER ;
SELECT fn_total_anual(2024) AS TotalAnual;


DELIMITER //
CREATE FUNCTION fn_empleado_porcentaje(idEmp INT, anio INT)
RETURNS DECIMAL(5,2)
DETERMINISTIC
BEGIN
    DECLARE totalEmpleado DECIMAL(18,2);
    DECLARE totalAnual DECIMAL(18,2);

    -- Total que factur칩 el empleado
    SELECT SUM(dp.Cantidad * dp.PrecioUnidad * (1 - dp.Descuento))
    INTO totalEmpleado
    FROM detalles_de_pedido dp
    JOIN pedido p ON dp.IdPedido = p.IdPedido
    WHERE YEAR(p.FechaPedido) = anio
      AND p.IdEmpleado = idEmp;

    -- Total anual
    SET totalAnual = fn_total_anual(anio);

    RETURN fn_porcentaje(IFNULL(totalEmpleado,0), totalAnual);
END //
DELIMITER ;
SELECT fn_empleado_porcentaje(5, 2024) AS PorcentajeEmpleado;  



 DELIMITER //
CREATE FUNCTION fn_calculo_fecha(fecha DATE, codigo VARCHAR(20))
RETURNS DECIMAL(18,2)
DETERMINISTIC
BEGIN
    DECLARE resultado DECIMAL(18,2);

    -- Caso empleado
    IF EXISTS (SELECT 1 FROM empleado WHERE IdEmpleado = codigo) THEN
        SELECT SUM(dp.Cantidad * dp.PrecioUnidad * (1 - dp.Descuento))
        INTO resultado
        FROM detalles_de_pedido dp
        JOIN pedido p ON dp.IdPedido = p.IdPedido
        WHERE p.IdEmpleado = codigo AND p.FechaPedido = fecha;

    -- Caso cliente
    ELSEIF EXISTS (SELECT 1 FROM cliente WHERE IdCliente = codigo) THEN
        SELECT SUM(dp.Cantidad * dp.PrecioUnidad * (1 - dp.Descuento))
        INTO resultado
        FROM detalles_de_pedido dp
        JOIN pedido p ON dp.IdPedido = p.IdPedido
        WHERE p.IdCliente = codigo AND p.FechaPedido = fecha;

    -- Caso empresa transporte
    ELSEIF EXISTS (SELECT 1 FROM empresastransporte WHERE IdEmpresasTransporte = codigo) THEN
        SELECT SUM(dp.Cantidad * dp.PrecioUnidad * (1 - dp.Descuento))
        INTO resultado
        FROM detalles_de_pedido dp
        JOIN pedido p ON dp.IdPedido = p.IdPedido
        WHERE p.IdEmpresasTransporte = codigo AND p.FechaPedido = fecha;
    ELSE
        SET resultado = 0;
    END IF;

    RETURN IFNULL(resultado, 0);
END //
DELIMITER ;


-- Caso empleado
SELECT fn_calculo_fecha('2024-05-10', '5') AS TotalEmpleado;

-- Caso cliente
SELECT fn_calculo_fecha('2024-05-10', 'ALFKI') AS TotalCliente;

-- Caso empresa transporte
SELECT fn_calculo_fecha('2024-05-10', '1') AS TotalTransporte;


DELIMITER //
CREATE FUNCTION fn_total_pedido(idPed INT)
RETURNS DECIMAL(18,2)
DETERMINISTIC
BEGIN
    DECLARE total DECIMAL(18,2);

    SELECT SUM(dp.Cantidad * dp.PrecioUnidad * (1 - dp.Descuento))
    INTO total
    FROM detalles_de_pedido dp
    WHERE dp.IdPedido = idPed;

    RETURN IFNULL(total, 0);
END //
DELIMITER ;

SELECT fn_total_pedido(10248) AS TotalPedido;  
-- Ejemplo con pedido IdPedido = 10248


CREATE OR REPLACE VIEW vw_pedidos_cobros AS
SELECT 
    p.IdPedido,
    p.FechaPedido,
    p.flete,
    fn_total_pedido(p.IdPedido) AS Subtotal,
    (fn_total_pedido(p.IdPedido) + IFNULL(p.flete,0)) AS TotalConFlete
FROM pedido p;


CREATE OR REPLACE VIEW vista_domicilios AS
SELECT 
    d.id_domicilio,
    c.nombre AS nombre_cliente,
    c.direccion,
    s.descripcion AS descripcion_servicio,
    d.fecha,
    d.monto,
    u.nombre AS usuario_registro
FROM domicilio d
JOIN cliente c ON d.cliente_id = c.id_cliente
JOIN servicio s ON d.servicio_id = s.id_servicio
JOIN usuario u ON d.usuario_id = u.id_usuario;


select * from producto;
SELECT * FROM vw_pedidos_cobros;
select * from cliente;
select * from inventarioherramientas;
select * from inventarioproductos;
select * from usuario;
select * from compra;
select * from mantenimiento;
select * from servicio;
select * from devoluciones;
select * from domicilio;
select * from proveedor;


